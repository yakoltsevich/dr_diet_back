import { Injectable } from '@nestjs/common';

@Injectable()
export class PromptBuilder {
  buildDishPlan(profile: any): string {
    return `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥. –°–æ—Å—Ç–∞–≤—å –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é (7 –¥–Ω–µ–π), –Ω–∞—á–∏–Ω–∞—è —Å –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞.

üî∏ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON, —Å—Ç—Ä–æ–≥–æ –æ–¥–∏–Ω –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
- –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π: [ { "day": 1, "breakfast": { "dish": "..." }, ... }, ... ]
- –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å –æ–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–π: "data", "days", "menu", "week_menu", –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –º–∞—Å—Å–∏–≤

üîπ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è:
{
  "day": 1,
  "breakfast": { "dish": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞" },
  "lunch": { "dish": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞" },
  "dinner": { "dish": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞" }
}

üîπ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –±–ª—é–¥–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
- –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON
- –ù–∞–∑–≤–∞–Ω–∏—è –±–ª—é–¥ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –ü–æ–ª: ${profile.gender}
- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${profile.birthDate}
- –†–æ—Å—Ç: ${profile.height} —Å–º
- –í–µ—Å: ${profile.weight} –∫–≥
- –¶–µ–ª—å: ${profile.goal}
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${profile.activityLevel}
- –ê–ª–ª–µ—Ä–≥–∏–∏: ${profile.allergies?.join(', ') || '–Ω–µ—Ç'}
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${profile.dietaryPreferences?.join(', ') || '–Ω–µ—Ç'}
- –õ—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${profile.favoriteFoods?.join(', ') || '–Ω–µ—Ç'}
- –ù–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${profile.dislikedFoods?.join(', ') || '–Ω–µ—Ç'}
    `.trim();
  }

  buildNutrientsPrompt(dishName: string, profile: any): string {
    const calories = profile.calories || 1800;
    const protein = profile.proteins || 120;

    return `
–¢—ã –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –û—Ü–µ–Ω–∏ –ø—Ä–∏–º–µ—Ä–Ω—É—é –ø–∏—â–µ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –±–ª—é–¥–∞ "${dishName}" –≤ –≥—Ä–∞–º–º–∞—Ö –∏ –∫–∞–ª–æ—Ä–∏—è—Ö.

üîπ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ JSON:
{
  "calories": —á–∏—Å–ª–æ, // —Ü–µ–ª–æ–µ
  "protein": —á–∏—Å–ª–æ,  // –≥—Ä–∞–º–º—ã
  "fat": —á–∏—Å–ª–æ,      // –≥—Ä–∞–º–º—ã
  "carbs": —á–∏—Å–ª–æ     // –≥—Ä–∞–º–º—ã
}

üî∏ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –†–∞—Å—á—ë—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é —Å—É—Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Ü–∏–æ–Ω–∞.
- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É—Ç–æ—á–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –±—ã–ª–∞ **${calories} ¬± 5%**
- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É—Ç–æ—á–Ω—ã–π –±–µ–ª–æ–∫ –±—ã–ª **${protein} ¬± 5%**–≥
- –ü—Ä–∏–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –∑–∞–≤—Ç—Ä–∞–∫ ‚Äî 30%, –æ–±–µ–¥ ‚Äî 35%, —É–∂–∏–Ω ‚Äî 35%.
- –ù–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤–Ω–µ JSON. –¢–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã—à–µ.
`.trim();
  }

  buildRecipePrompt(dishName: string): string {
    return `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–≤–∞—Ä. –°–æ—Å—Ç–∞–≤—å —Ä–µ—Ü–µ–ø—Ç –±–ª—é–¥–∞ "${dishName}" –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

üîπ –§–æ—Ä–º–∞—Ç:
{
  "recipe": {
    "ingredients": [
      { "item": "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞", "amount": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å –µ–¥–∏–Ω–∏—Ü–µ–π –∏–∑–º–µ—Ä–µ–Ω–∏—è" }
    ],
    "steps": [
      "–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è 1",
      "–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è 2"
    ]
  },
  "total": {
    "calories": —á–∏—Å–ª–æ,
    "protein": —á–∏—Å–ª–æ,
    "fat": —á–∏—Å–ª–æ,
    "carbs": —á–∏—Å–ª–æ
  }
}

üî∏ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –°—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –ù–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON
- –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ total ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞
    `.trim();
  }

  buildRecipeOnlyPrompt(dish: string): string {
    return `
–¢—ã –ø–æ–≤–∞—Ä. –°–æ—Å—Ç–∞–≤—å —Ä–µ—Ü–µ–ø—Ç –±–ª—é–¥–∞ "${dish}" —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

üî∏ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
{
  "recipe": {
    "ingredients": [
      { "item": "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç", "amount": "100 –≥" }
    ],
    "steps": ["–®–∞–≥ 1", "–®–∞–≥ 2"]
  }
}

- –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON
    `.trim();
  }
  buildMenuWithNutrition(profile: any): string {
    return `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥ –∏ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ 7 –¥–Ω–µ–π —Å —É—á—ë—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

üéØ –¶–µ–ª—å:
- –ö–∞–ª–æ—Ä–∏–∏ –≤ –¥–µ–Ω—å: ~${profile.calories || 1800}
- –ë–µ–ª–∫–∏ –≤ –¥–µ–Ω—å: ~${profile.proteins || 120} –≥
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—ë–º–∞–º –ø–∏—â–∏: –∑–∞–≤—Ç—Ä–∞–∫ 30%, –æ–±–µ–¥ 35%, —É–∂–∏–Ω 35%

üìå –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –±–ª—é–¥
- –¢–æ–ª—å–∫–æ JSON ‚Äî —Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∫ –Ω–∏–∂–µ
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON
- –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –∞–ª–ª–µ—Ä–≥–∏—é

üì¶ –§–æ—Ä–º–∞—Ç:
[
  {
    "day": 1,
    "breakfast": {
      "dish": "–û–≤—Å—è–Ω–∫–∞ —Å —è–≥–æ–¥–∞–º–∏",
      "total": {
        "calories": —á–∏—Å–ª–æ,
        "protein": —á–∏—Å–ª–æ,
        "fat": —á–∏—Å–ª–æ,
        "carbs": —á–∏—Å–ª–æ
      }
    },
    "lunch": { ... },
    "dinner": { ... }
  },
  ...
]
    
üë§ –ü—Ä–æ—Ñ–∏–ª—å:
- –ü–æ–ª: ${profile.gender}
- –í–æ–∑—Ä–∞—Å—Ç: ${profile.birthDate}
- –†–æ—Å—Ç: ${profile.height} —Å–º
- –í–µ—Å: ${profile.weight} –∫–≥
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${profile.activityLevel}
- –¶–µ–ª—å: ${profile.goal || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
- –ê–ª–ª–µ—Ä–≥–∏–∏: ${profile.allergies?.join(', ') || '–Ω–µ—Ç'}
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${profile.dietaryPreferences?.join(', ') || '–Ω–µ—Ç'}
- –õ—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${profile.favoriteFoods?.join(', ') || '–Ω–µ—Ç'}
- –ù–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${profile.dislikedFoods?.join(', ') || '–Ω–µ—Ç'}
  `.trim();
  }
  buildMenuWithNutritionPrompt(profile: any): string {
    return `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥. –°–æ—Å—Ç–∞–≤—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é –Ω–∞ 7 –¥–Ω–µ–π.

üî∏ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON:
{
  "meal_plan": [
    {
      "day": 1,
      "breakfast": {
        "dish": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "total": {
          "calories": —á–∏—Å–ª–æ,
          "protein": —á–∏—Å–ª–æ,
          "fat": —á–∏—Å–ª–æ,
          "carbs": —á–∏—Å–ª–æ
        }
      },
      "lunch": { ... },
      "dinner": { ... }
    },
    ...
  ]
}

üîπ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ù–µ –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –≤–Ω–µ JSON
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ –≤ total
- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å 3 —Ä–∞–∑–Ω—ã—Ö –±–ª—é–¥–∞ (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤)
- –ú–µ–Ω—é –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

üìå –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –ü–æ–ª: ${profile.gender}
- –í–æ–∑—Ä–∞—Å—Ç: ${this.getAge(profile.birthDate)} –ª–µ—Ç
- –†–æ—Å—Ç: ${profile.height} —Å–º
- –í–µ—Å: ${profile.weight} –∫–≥
- –¶–µ–ª—å: ${profile.goal || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${profile.activityLevel}
- –ö–∞–ª–æ—Ä–∏–∏: ${profile.calories || '–∞–≤—Ç–æ'}
- –ë–µ–ª–∫–∏: ${profile.proteins || '–∞–≤—Ç–æ'}
- –ê–ª–ª–µ—Ä–≥–∏–∏: ${profile.allergies?.join(', ') || '–Ω–µ—Ç'}
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${profile.dietaryPreferences?.join(', ') || '–Ω–µ—Ç'}
- –õ—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${profile.favoriteFoods?.join(', ') || '–Ω–µ—Ç'}
- –ù–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${profile.dislikedFoods?.join(', ') || '–Ω–µ—Ç'}
    `.trim();
  }

  private getAge(birthDate: string): number {
    const birth = new Date(birthDate);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    const m = now.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  }
  private getTargetMacrosFromProfile(profile: any) {
    const calories = profile.calories || 1800;
    const protein = profile.proteins || 120;
    const fat = profile.fats || Math.round(0.8 * profile.weight || 70);
    const carbs =
      profile.carbs || Math.round((calories - (protein * 4 + fat * 9)) / 4);

    return { calories, protein, fat, carbs };
  }
}
